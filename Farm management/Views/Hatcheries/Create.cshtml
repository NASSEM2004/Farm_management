@model Farm_management.Models.Hatchery

@{
    ViewData["Title"] = "إنشاء عملية تفريخ";
}

<style>
    body {
        background-image: url('/css/images/imge18.jpg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
    }

    .main-content-wrapper {
        background-color: rgba(255, 255, 255, 0.85);
        border-radius: 15px;
        padding: 25px;
        margin-top: 30px;
        backdrop-filter: blur(8px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .animal-selection-card {
        border: none;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .table-responsive {
        background: white;
        scrollbar-width: thin;
    }

    .form-label {
        color: #333;
    }
</style>

<div class="container-fluid py-4">
    <div class="main-content-wrapper mx-auto" style="max-width: 1100px;">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
            <h2 class="fw-bold text-dark"><i class="bi bi-egg-fried text-warning"></i> إنشاء عملية تفريخ جديدة</h2>
            <a asp-action="Index" class="btn btn-outline-secondary btn-sm">العودة للسجل</a>
        </div>

        <form asp-action="Create" id="hatcheryForm">
            @* المرحلة الأولى: اختيار الحظيرة *@
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold"><i class="bi bi-house-door"></i> اختر حظيرة الآباء</label>
                    <select id="parentBarnSelect" class="form-select border-primary shadow-sm" asp-items="ViewBag.ParentBarns">
                        <option value="">-- حدد الحظيرة لجلب الحيوانات --</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold"><i class="bi bi-tag"></i> تخصص الحظيرة (نوع الحياة)</label>
                    <input type="text" id="kindOfLifeInput" class="form-control bg-white shadow-sm fw-bold text-primary" readonly placeholder="سيظهر التخصص تلقائياً..." />
                </div>
            </div>

            @* المرحلة الثانية: اختيار الأبوين *@
            <div class="row">
                <div class="col-md-6">
                    <div class="card animal-selection-card shadow-sm mb-4 border-start border-primary border-4">
                        <div class="card-header bg-primary text-white py-2">
                            <i class="bi bi-gender-male"></i> الذكور المتاحة
                        </div>
                        <div class="table-responsive" style="max-height: 250px;">
                            <table class="table table-hover align-middle mb-0 text-center" id="maleTable">
                                <thead class="table-light">
                                    <tr><th>إختيار</th><th>#</th><th>الفصيلة</th><th>العمر</th></tr>
                                </thead>
                                <tbody>
                                    <tr class="text-muted"><td colspan="4">اختر حظيرة أولاً...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card animal-selection-card shadow-sm mb-4 border-start border-danger border-4">
                        <div class="card-header bg-danger text-white py-2">
                            <i class="bi bi-gender-female"></i> الإناث المتاحة
                        </div>
                        <div class="table-responsive" style="max-height: 250px;">
                            <table class="table table-hover align-middle mb-0 text-center" id="femaleTable">
                                <thead class="table-light">
                                    <tr><th>إختيار</th><th>#</th><th>الفصيلة</th><th>العمر</th></tr>
                                </thead>
                                <tbody>
                                    <tr class="text-muted"><td colspan="4">اختر حظيرة أولاً...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            @* المرحلة الثالثة: بيانات الإنتاج *@
            <div class="row mt-2 p-4 bg-white rounded shadow-sm border">
                <h5 class="mb-3 text-secondary border-bottom pb-2">تفاصيل الإنتاج والتواريخ</h5>
                <div class="col-md-4 mb-3">
                    <label asp-for="ProductionBarnId" class="form-label fw-bold">حظيرة الإنتاج المستهدفة</label>
                    <select asp-for="ProductionBarnId" class="form-select border-info" asp-items="ViewBag.ProductionBarnId">
                        <option value="">-- اختر حظيرة الإنتاج --</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label asp-for="StartDate" class="form-label fw-bold">تاريخ الإدخال</label>
                    <input asp-for="StartDate" class="form-control" type="datetime-local" />
                </div>
                <div class="col-md-4 mb-3">
                    <label asp-for="ExpectedEndDate" class="form-label fw-bold">موعد الإنتاج المتوقع</label>
                    <input asp-for="ExpectedEndDate" class="form-control border-success fw-bold text-success" type="datetime-local" />
                </div>
            </div>

            <div class="text-center mt-4 pt-3">
                <button type="submit" class="btn btn-success btn-lg px-5 shadow-lg fw-bold">
                    <i class="bi bi-check-circle-fill"></i> حفظ وبدء العملية
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#parentBarnSelect').change(function () {
                var barnId = $(this).val();
                if (!barnId) {
                    $('#kindOfLifeInput').val('');
                    $('#maleTable tbody').html('<tr class="text-muted"><td colspan="4">اختر حظيرة أولاً...</td></tr>');
                    $('#femaleTable tbody').html('<tr class="text-muted"><td colspan="4">اختر حظيرة أولاً...</td></tr>');
                    return;
                }

                $.ajax({
                    url: '/Hatcheries/GetAnimalsByBarn',
                    type: 'GET',
                    data: { barnId: barnId },
                    success: function (response) {
                        if (response) {
                            $('#kindOfLifeInput').val(response.specialization);
                            var maleBody = $('#maleTable tbody').empty();
                            var femaleBody = $('#femaleTable tbody').empty();

                            if (response.animals.length === 0) {
                                maleBody.append('<tr><td colspan="4" class="text-danger">لا توجد حيوانات</td></tr>');
                                femaleBody.append('<tr><td colspan="4" class="text-danger">لا توجد حيوانات</td></tr>');
                            }

                            response.animals.forEach(function (animal) {
                                var row = `<tr>
                                    <td><input type="radio" class="form-check-input shadow-sm" name="${animal.gender === 'ذكر' ? 'MaleAnimalId' : 'FemaleAnimalId'}" value="${animal.id}" required /></td>
                                    <td class="fw-bold text-muted">${animal.id}</td>
                                    <td><span class="badge bg-light text-dark border">${animal.species}</span></td>
                                    <td>${animal.age} يوم</td>
                                </tr>`;

                                if (animal.gender === 'ذكر') { maleBody.append(row); }
                                else { femaleBody.append(row); }
                            });
                        }
                    },
                    error: function () {
                        alert("حدث خطأ أثناء جلب البيانات.");
                    }
                });
            });
        });
    </script>
}