@model Farm_management.Models.Animals

@{
    ViewData["Title"] = "إضافة حيوان";
}

<h2>إضافة حيوان جديد</h2>

<form asp-action="Create" method="post">
    @Html.AntiForgeryToken()

    <div asp-validation-summary="ModelOnly" style="color:red;"></div>

    <div>
        <label asp-for="Name">الاسم (النوع)</label>
        <input asp-for="Name" />
        <span asp-validation-for="Name" style="color:red;"></span>
    </div>

    <div>
        <label asp-for="Species">الفصيلة</label>
        <input asp-for="Species" />
        <span asp-validation-for="Species" style="color:red;"></span>
    </div>

    <div>
        <label asp-for="Age">العمر</label>
        <input asp-for="Age" type="number" />
        <span asp-validation-for="Age" style="color:red;"></span>
    </div>

    <div>
        <label asp-for="Gender">الجنس</label>
        <select asp-for="Gender">
            <option value="">-- اختر الجنس --</option>
            <option value="ذكر">ذكر</option>
            <option value="أنثى">أنثى</option>
        </select>
        <span asp-validation-for="Gender" style="color:red;"></span>
    </div>

    <div>
        <label asp-for="BarnId">الحظيرة</label>
        <select asp-for="BarnId" asp-items="ViewBag.BarnId">
            <option value="">-- اختر الحظيرة --</option>
        </select>
        <span asp-validation-for="BarnId" style="color:red;"></span>
    </div>

    <br />
    <button type="submit">حفظ البيانات</button>
</form>

@section Scripts {
    <script>
        // هذا السكربت يراقب تغيير "الاسم/النوع" ويجلب الحظائر المتوافقة
        document.getElementById('Name').addEventListener('blur', function () {
            const kindValue = this.value; // القيمة المدخلة في حقل الاسم (مثلاً: خروف)
            const barnSelect = document.querySelector('select[name="BarnId"]');

            if (!kindValue) return;

            // إظهار رسالة مؤقتة
            barnSelect.innerHTML = '<option value="">جاري البحث عن حظائر متاحة...</option>';

            // استدعاء الأكشن الذكي GetBarnsByKind من AnimalsController
            fetch(`/Animals/GetBarnsByKind?kind=${encodeURIComponent(kindValue)}`)
                .then(res => res.json())
                .then(data => {
                    barnSelect.innerHTML = '<option value="">-- اختر حظيرة مناسبة --</option>';

                    if (data.length === 0) {
                        barnSelect.innerHTML = '<option value="">لا توجد حظائر متوافقة مع هذا النوع</option>';
                    } else {
                        data.forEach(barn => {
                            const option = document.createElement('option');
                            option.value = barn.id;
                            option.textContent = barn.name;
                            barnSelect.appendChild(option);
                        });
                    }
                })
                .catch(err => {
                    console.error("خطأ في جلب البيانات:", err);
                    barnSelect.innerHTML = '<option value="">خطأ في تحميل الحظائر</option>';
                });
        });
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}